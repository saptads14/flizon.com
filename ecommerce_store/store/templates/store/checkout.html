<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Checkout | FLIZON</title>
  {% load static %}
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <style>
    html,body{margin:0;padding:0;background:#f8f9fa;font-family:Arial, sans-serif}
    .page-wrap{max-width:1180px;margin:28px auto;padding:0 16px}
    .checkout-container{background:#fff;border-radius:10px;padding:26px;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    h1{font-size:1.6rem;margin-bottom:18px;color:#212529}
    .section-title{font-weight:700;color:#343a40;margin-bottom:10px}
    .address-card,.payment-card{border:1px solid #e6e6e6;border-radius:8px;padding:12px;background:#fff;cursor:pointer;transition:.12s}
    .address-card:hover,.payment-card:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.04)}
    .address-card.selected{border-color:#0d6efd;box-shadow:0 6px 26px rgba(13,110,253,.12)}
    .address-small{color:#6c757d;font-size:.92rem;margin-top:6px}

    /* ✅ Full-width navbar fix */
    header.container-fluid {
      padding-left: 0 !important;
      padding-right: 0 !important;
      margin: 0 !important;
      width: 100%;
    }

    .site-footer{width:100vw;left:50%;margin-left:-50vw;background:linear-gradient(90deg,#0d6efd,#0b5ed7);color:#fff;padding:28px 16px;position:relative}
    .site-footer .footer-inner{max-width:1180px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    @media(max-width:767px){.page-wrap{margin:16px;padding:0 10px}}
  </style>
</head>
<body>
  <header class="container-fluid">
    {% include "store/navbar.html" %}
  </header>

  <main class="page-wrap">
    <div class="checkout-container">
      {% if messages %}
      <div class="mb-3">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags|default:'info' }}">{{ message }}</div>
        {% endfor %}
      </div>
      {% endif %}

      <!-- Entire checkout posts to order_placed -->
      <form method="post" action="{% url 'order_placed' %}" id="checkoutForm">
        {% csrf_token %}

        <div class="row g-4">
          <div class="col-lg-8">
            <div class="mb-3 d-flex justify-content-between align-items-center">
              <div class="section-title">DELIVERY ADDRESS</div>
              <!-- trigger Add Address modal -->
              <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addressModal" id="addAddressBtn">
                <i class="fa fa-plus"></i> Add address
              </button>
            </div>

            <div class="row g-3" id="addressList">
              {% if addresses %}
                {% for addr in addresses %}
                <div class="col-md-6" data-addr-id="{{ addr.id }}">
                  <div class="address-card" tabindex="0">
                    <div class="d-flex justify-content-between">
                      <div>
                        <div class="fw-bold">{{ addr.full_name }}</div>
                        <div class="address-small">{{ addr.line1 }}{% if addr.line2 %}, {{ addr.line2 }}{% endif %}</div>
                        <div class="address-small">{{ addr.city }}, {{ addr.state }} - {{ addr.pincode }}</div>
                        <div class="address-small">Phone: {{ addr.phone }}</div>
                        {% if addr.is_default %}<div class="badge bg-success mt-2">Default</div>{% endif %}
                      </div>

                      <div class="ms-2 d-flex flex-column align-items-end">
                        <div class="form-check">
                          <input class="form-check-input address-radio" type="radio" name="selected_address" id="addr_{{ addr.id }}" value="{{ addr.id }}" {% if forloop.first %}checked{% endif %}>
                        </div>
                        <div class="mt-2">
                          <button type="button" class="btn btn-sm btn-outline-secondary edit-address-btn" data-addr='{
                            "id":"{{ addr.id }}",
                            "full_name":"{{ addr.full_name|escapejs }}",
                            "line1":"{{ addr.line1|escapejs }}",
                            "line2":"{{ addr.line2|escapejs }}",
                            "city":"{{ addr.city|escapejs }}",
                            "state":"{{ addr.state|escapejs }}",
                            "pincode":"{{ addr.pincode|escapejs }}",
                            "phone":"{{ addr.phone|escapejs }}",
                            "is_default":"{{ addr.is_default|yesno:"true,false" }}"
                          }'>Edit</button>

                          <form method="post" action="{% url 'delete_address' %}" style="display:inline;" class="d-inline delete-address-form">
                            {% csrf_token %}
                            <input type="hidden" name="addr_id" value="{{ addr.id }}">
                            <button type="submit" class="btn btn-sm btn-outline-danger ms-1 remove-address-btn">Remove</button>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                {% endfor %}
              {% else %}
                <div class="col-12">
                  <div class="address-card">
                    <strong>No saved addresses</strong>
                    <div class="address-small">Add an address to get started.</div>
                    <div class="mt-3">
                      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addressModal">+ Add address</button>
                    </div>
                  </div>
                </div>
              {% endif %}
            </div>

            <!-- Payment Methods (updated) -->
<div class="mb-4 mt-4">
  <div class="section-title">Payment Method</div>
  <div class="row g-3">
    <div class="col-md-6">
      <label class="d-block">
        <div class="payment-card d-flex justify-content-between align-items-center">
          <div><i class="fa fa-money fa-lg me-2 text-success"></i>
            <div class="fw-bold">Cash on Delivery</div>
            <div class="small text-muted">Pay on delivery</div>
          </div>
          <div class="form-check">
            <input class="form-check-input payment-radio" type="radio" name="payment_method" value="cod">
          </div>
        </div>
      </label>
    </div>

    <div class="col-md-6">
      <label class="d-block">
        <div class="payment-card d-flex justify-content-between align-items-center">
          <div><i class="fa fa-university fa-lg me-2 text-primary"></i>
            <div class="fw-bold">Net Banking</div>
            <div class="small text-muted">Pay securely through your bank</div>
          </div>
          <div class="form-check">
            <input class="form-check-input payment-radio" type="radio" name="payment_method" value="netbanking">
          </div>
        </div>
      </label>
    </div>

    <div class="col-md-6">
      <label class="d-block">
        <div class="payment-card d-flex justify-content-between align-items-center">
          <div><i class="fa fa-credit-card fa-lg me-2 text-warning"></i>
            <div class="fw-bold">Debit / Credit / ATM Card</div>
            <div class="small text-muted">Visa, MasterCard, RuPay, etc.</div>
          </div>
          <div class="form-check">
            <input class="form-check-input payment-radio" type="radio" name="payment_method" value="card">
          </div>
        </div>
      </label>
    </div>

    <div class="col-md-6">
      <label class="d-block">
        <div class="payment-card d-flex justify-content-between align-items-center">
          <div><i class="fa fa-google-wallet fa-lg me-2 text-danger"></i>
            <div class="fw-bold">UPI</div>
            <div class="small text-muted">Google Pay, PhonePe, Paytm, etc.</div>
          </div>
          <div class="form-check">
            <input class="form-check-input payment-radio" type="radio" name="payment_method" value="upi">
          </div>
        </div>
      </label>
    </div>
  </div>
</div>


          </div>

          <div class="col-lg-4">
            <div class="sticky-top" style="top:20px">
              <div class="section-title">Order Summary</div>
              <table class="table table-bordered mb-3">
                <thead><tr><th>Item</th><th class="text-end">Amount</th></tr></thead>
                <tbody>
                  <tr><td>Sub Total</td><td class="text-end">{{ total }}</td></tr>
                  <tr><td>CGST (5%)</td><td class="text-end">{{ cgst }}</td></tr>
                  <tr><td>SGST (5%)</td><td class="text-end">{{ sgst }}</td></tr>
                  <tr class="fw-bold"><td>Grand Total</td><td class="text-end">{{ grand_total }}</td></tr>
                </tbody>
              </table>

              <!-- Hidden backups -->
              <input type="hidden" name="hidden_selected_address" id="hidden_selected_address" value="">
              <input type="hidden" name="hidden_payment_method" id="hidden_payment_method" value="">

              <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary btn-lg" id="placeOrderBtn">Place Order</button>
                <a class="btn btn-outline-secondary btn-lg" href="{% url 'home' %}">Back to Home</a>
              </div>
            </div>
          </div>
        </div>
      </form>

    </div>
  </main>

  <!-- Address Add/Edit Modal -->
  <div class="modal fade" id="addressModal" tabindex="-1" aria-labelledby="addressModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form method="post" id="addressForm" action="{% url 'add_address' %}">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title" id="addressModalLabel">Add address</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" name="addr_id" id="addr_id" value="">
            <div class="row g-3">
              <div class="col-md-6"><label class="form-label">Full name</label><input name="full_name" id="full_name" class="form-control" required></div>
              <div class="col-md-6"><label class="form-label">Phone</label><input name="phone" id="phone" class="form-control" required></div>
              <div class="col-12"><label class="form-label">Address line 1</label><input name="line1" id="line1" class="form-control" required></div>
              <div class="col-12"><label class="form-label">Address line 2 (optional)</label><input name="line2" id="line2" class="form-control"></div>
              <div class="col-md-4"><label class="form-label">City</label><input name="city" id="city" class="form-control" required></div>
              <div class="col-md-4"><label class="form-label">State</label><input name="state" id="state" class="form-control" required></div>
              <div class="col-md-4"><label class="form-label">Pincode</label><input name="pincode" id="pincode" class="form-control" required></div>
              <div class="col-12"><div class="form-check mt-2"><input class="form-check-input" type="checkbox" name="is_default" id="is_default"><label class="form-check-label" for="is_default">Make this my default address</label></div></div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary" id="saveAddressBtn">Save address</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  {% include "store/footer.html" %}

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
 <script>
document.addEventListener('DOMContentLoaded', function() {

  // Highlight selected address card
  document.querySelectorAll('.address-card').forEach(card => {
    card.addEventListener('click', function(e){
      if (e.target.closest('.edit-address-btn') || e.target.closest('.remove-address-btn') || e.target.closest('form')) return;
      const radio = this.querySelector('.address-radio');
      if (radio) radio.checked = true;
      document.querySelectorAll('.address-card').forEach(c=>c.classList.remove('selected'));
      this.classList.add('selected');
      togglePlaceOrderButton();
    });
  });

  const addressModal = new bootstrap.Modal(document.getElementById('addressModal'));

  // Edit address
  document.querySelectorAll('.edit-address-btn').forEach(btn => {
    btn.addEventListener('click', function(){
      const data = JSON.parse(this.getAttribute('data-addr'));
      document.getElementById('addr_id').value = data.id;
      document.getElementById('full_name').value = data.full_name;
      document.getElementById('phone').value = data.phone;
      document.getElementById('line1').value = data.line1;
      document.getElementById('line2').value = data.line2;
      document.getElementById('city').value = data.city;
      document.getElementById('state').value = data.state;
      document.getElementById('pincode').value = data.pincode;
      document.getElementById('is_default').checked = (data.is_default === "true");
      const form = document.getElementById('addressForm');
      form.action = "{% url 'edit_address' %}";
      document.getElementById('addressModalLabel').textContent = 'Edit address';
      document.getElementById('saveAddressBtn').textContent = 'Save changes';
      addressModal.show();
    });
  });

  // Add new address
  document.getElementById('addAddressBtn').addEventListener('click', function(){
    const form = document.getElementById('addressForm');
    form.reset();
    form.action = "{% url 'add_address' %}";
    document.getElementById('addr_id').value = '';
    document.getElementById('addressModalLabel').textContent = 'Add address';
    document.getElementById('saveAddressBtn').textContent = 'Save address';
  });

// ✅ Fix: Ensure delete works properly
document.querySelectorAll('.delete-address-form').forEach(form => {
  const btn = form.querySelector('.remove-address-btn');
  if (btn) {
    btn.addEventListener('click', function(e) {
      e.stopPropagation(); // prevent card click
      if (!confirm('Are you sure you want to remove this address?')) {
        e.preventDefault();
      } else {
        form.submit(); // manually submit the form
      }
    });
  }
});


  // Enable Place Order button only if both selected
  const placeOrderBtn = document.getElementById('placeOrderBtn');
  const checkoutForm = document.getElementById('checkoutForm');

  function togglePlaceOrderButton() {
    const addr = document.querySelector('input[name="selected_address"]:checked');
    const pay = document.querySelector('input[name="payment_method"]:checked');
    placeOrderBtn.disabled = !(addr && pay);
  }

  // Run on page load and on input change
  togglePlaceOrderButton();
  document.querySelectorAll('.address-radio, .payment-radio').forEach(el => {
    el.addEventListener('change', togglePlaceOrderButton);
  });

  checkoutForm.addEventListener('submit', function(e){
    const selectedAddr = document.querySelector('input[name="selected_address"]:checked');
    const selectedPay = document.querySelector('input[name="payment_method"]:checked');
    if (!selectedAddr) { e.preventDefault(); alert('Please choose a delivery address.'); return false; }
    if (!selectedPay) { e.preventDefault(); alert('Please choose a payment method.'); return false; }
    document.getElementById('hidden_selected_address').value = selectedAddr.value;
    document.getElementById('hidden_payment_method').value = selectedPay.value;
  });

  // Keep preselected address highlighted
  document.querySelectorAll('.address-radio:checked').forEach(r => {
    const c = r.closest('.address-card'); if (c) c.classList.add('selected');
  });

});
</script>
</body>
</html>
